<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Trace Letter C with Stable Font</title>
<style>
  @import url('https://cdn.jsdelivr.net/gh/antijingoist/open-dyslexic/web/open-dyslexic.css');
  body {
    font-family: 'OpenDyslexic', sans-serif;
    text-align: center;
    margin: 20px;
    background: #f9f9f9;
  }
  #container {
    position: relative;
    width: 500px;
    height: 400px;
    margin: 20px auto;
  }
  canvas {
    position: absolute;
    left: 0; top: 0;
    border: 1px solid #ccc;
    background: transparent;
    touch-action: none;
  }
  #backgroundCanvas {
    z-index: 0;
  }
  #traceCanvas {
    z-index: 1;
  }
  #message {
    font-size: 24px;
    font-weight: bold;
    margin-top: 20px;
  }
  #startBtn {
    font-size: 24px;
    padding: 10px 20px;
    margin-top: 30px;
    cursor: pointer;
  }
</style>
</head>
<body>

<h2>Trace the letter "c"</h2>
<div id="container">
  <canvas id="backgroundCanvas" width="500" height="400"></canvas>
  <canvas id="traceCanvas" width="500" height="400"></canvas>
</div>
<div id="message"></div>

<button id="startBtn">Tap to Begin</button>

<script>
  const bgCanvas = document.getElementById("backgroundCanvas");
  const bgCtx = bgCanvas.getContext("2d");

  const traceCanvas = document.getElementById("traceCanvas");
  const traceCtx = traceCanvas.getContext("2d");

  const message = document.getElementById("message");
  const startBtn = document.getElementById("startBtn");

  // Letter c fixed position
  const letterX = 160;
  const letterY = 280;

  // Stroke control points
  const points = {
    start:      {x: 258.9, y: 198.0},
    control1:   {x: 195.9, y: 153.0},
    mid:        {x: 174.9, y: 227.0},
    control2:   {x: 196.9, y: 300.0},
    end:        {x: 256.9, y: 258.0}
  };

  function drawLetterAndArrow() {
    bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
    // Draw letter c using OpenDyslexic
    bgCtx.font = "200px 'OpenDyslexic', sans-serif";
    bgCtx.fillStyle = "black";
    bgCtx.textBaseline = "alphabetic";
    bgCtx.fillText("c", letterX, letterY);

    // Draw stroke arrow with two quadratic curves
    bgCtx.lineWidth = 3;
    bgCtx.strokeStyle = "blue";

    bgCtx.beginPath();
    bgCtx.moveTo(points.start.x, points.start.y);
    bgCtx.quadraticCurveTo(points.control1.x, points.control1.y, points.mid.x, points.mid.y);
    bgCtx.quadraticCurveTo(points.control2.x, points.control2.y, points.end.x, points.end.y);
    bgCtx.stroke();

    // Draw arrowhead at end
    drawArrowhead(bgCtx, points.end, points.control2);

    // Stroke number "1" at start
    bgCtx.fillStyle = "blue";
    bgCtx.font = "20px sans-serif";
    bgCtx.fillText("1", points.start.x - 15, points.start.y - 15);
  }

  function drawArrowhead(ctx, tip, tail, size = 12) {
    const angle = Math.atan2(tip.y - tail.y, tip.x - tail.x);
    const left = {
      x: tip.x - size * Math.cos(angle - Math.PI / 6),
      y: tip.y - size * Math.sin(angle - Math.PI / 6)
    };
    const right = {
      x: tip.x - size * Math.cos(angle + Math.PI / 6),
      y: tip.y - size * Math.sin(angle + Math.PI / 6)
    };
    ctx.beginPath();
    ctx.moveTo(tip.x, tip.y);
    ctx.lineTo(left.x, left.y);
    ctx.lineTo(right.x, right.y);
    ctx.closePath();
    ctx.fillStyle = "blue";
    ctx.fill();
  }

  // Tracing validation helpers
  function pointNearQuadraticCurve(px, py, p0, p1, p2, tolerance) {
    for(let t=0; t<=1; t+=0.02) {
      const cx = (1-t)**2*p0.x + 2*(1-t)*t*p1.x + t**2*p2.x;
      const cy = (1-t)**2*p0.y + 2*(1-t)*t*p1.y + t**2*p2.y;
      if(Math.hypot(px - cx, py - cy) <= tolerance) return true;
    }
    return false;
  }
  function pointOnStroke(px, py, tolerance=20) {
    if(pointNearQuadraticCurve(px, py, points.start, points.control1, points.mid, tolerance)) return true;
    if(pointNearQuadraticCurve(px, py, points.mid, points.control2, points.end, tolerance)) return true;
    return false;
  }

  // Tracing logic on traceCanvas only:
  let isDrawing = false;
  let tracedPoints = [];

  // Disable tracing initially
  traceCanvas.style.pointerEvents = "none";

  function getPos(e) {
    const rect = traceCanvas.getBoundingClientRect();
    if(e.touches) {
      return {x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top};
    } else {
      return {x: e.clientX - rect.left, y: e.clientY - rect.top};
    }
  }

  function startDraw(e) {
    e.preventDefault();
    isDrawing = true;
    tracedPoints = [];
    const pos = getPos(e);
    tracedPoints.push(pos);
  }

  function drawing(e) {
    if(!isDrawing) return;
    e.preventDefault();
    const pos = getPos(e);
    tracedPoints.push(pos);

    traceCtx.clearRect(0, 0, traceCanvas.width, traceCanvas.height);

    // Draw trace line, green if near stroke, else red
    const nearStroke = pointOnStroke(pos.x, pos.y);
    traceCtx.lineWidth = 4;
    traceCtx.strokeStyle = nearStroke ? "green" : "red";

    traceCtx.beginPath();
    traceCtx.moveTo(tracedPoints[0].x, tracedPoints[0].y);
    for(let i=1; i<tracedPoints.length; i++) {
      traceCtx.lineTo(tracedPoints[i].x, tracedPoints[i].y);
    }
    traceCtx.stroke();
  }

  function endDraw(e) {
    if(!isDrawing) return;
    e.preventDefault();
    isDrawing = false;

    let onPathCount = 0;
    for(const pt of tracedPoints) {
      if(pointOnStroke(pt.x, pt.y, 25)) onPathCount++;
    }
    const ratio = onPathCount / tracedPoints.length;

    if(ratio > 0.7) {
      message.style.color = "green";
      message.textContent = "✅ Great! You traced the letter c correctly.";
    } else {
      message.style.color = "red";
      message.textContent = "❌ Try again! Trace closer to the stroke.";
    }
  }

  // Draw the letter and arrow initially
  drawLetterAndArrow();

  // Setup event listeners for tracing - disabled until user taps start
  function enableTracing() {
    traceCanvas.style.pointerEvents = "auto";
    startBtn.style.display = "none";

    window.speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance("Trace the letter");
    utter.lang = "en-US";
    window.speechSynthesis.speak(utter);

    traceCanvas.addEventListener("mousedown", startDraw);
    traceCanvas.addEventListener("mousemove", drawing);
    traceCanvas.addEventListener("mouseup", endDraw);
    traceCanvas.addEventListener("mouseleave", endDraw);

    traceCanvas.addEventListener("touchstart", startDraw, {passive:false});
    traceCanvas.addEventListener("touchmove", drawing, {passive:false});
    traceCanvas.addEventListener("touchend", endDraw);
  }

  startBtn.addEventListener("click", enableTracing);
</script>

</body>
</html>
